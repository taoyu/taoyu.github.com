<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<title>SSH小技巧 - 无网不剩</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" />
		<link rel="stylesheet" type="text/css" href="/css/syntax.css" />
		<link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/lzyy">
		<script type="text/javascript">
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-1281124-20']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();
		</script>
	</head>

	<body>
		<div id="logo"><h1><a href="/">无网不剩</a></h1></div>
		<div id="wrapper">
			<div id="content">
				<a target="_blank" style="float:right;margin-top:15px" href="http://twitter.com/share?url=http://blog.leezhong.com/tech/2010/08/28/ssh-tips.html&via=lzyy&text=SSH小技巧"><span class="balloon">retweet</span><img src="/image/tweet.png" /></a>
				<h2>SSH小技巧</h2>
				<div class="cnt">
					<p class="date">2010-08-28</p>
<p>参考：<br />
<a href="http://blog.ksplice.com/2010/08/six-things-i-wish-mom-told-me-about-ssh/">Six Things I wish Mom told me(about ssh)</a><br />
<a href="http://troy.jdmz.net/rsync/index.html">Using Rsync and Ssh</a></p>
<p>用过linux的，对SSH应该就比较熟悉了，但有些技巧可能你未必知道。</p>
<h3>连接成功后运行命令</h3>
<p>我们都知道可以通过SSH获取远程shell，然后运行命令。如果只想运行单个命令的话，直接把命令附加在SSH命令之后即可，如</p>
<div class="highlight"><pre><code class="bash">wdaher@rocksteady:~<span class="nv">$ </span>ssh bebop uname -a
Linux bebop 2.6.32-24-generic <span class="c">#39-Ubuntu SMP Wed Jul 28 05:14:15 UTC 2010 x86_64 GNU/Linux</span>
</code></pre>
</div>
<p>这个最好结合无须输入密码的SSH登录。如果想获取python版本，直接&quot;ssh hostname python -V&quot;</p>
<p>但有些命令可能会报错，如&quot;top&quot;</p>
<div class="highlight"><pre><code class="bash">wdaher@rocksteady:~<span class="nv">$ </span>ssh bebop top
TERM environment variable not <span class="nb">set</span>.
</code></pre>
</div>
<p>这时只需加上&quot;-t&quot;参数就行了。</p>
<p>这里我们执行ssh连接时并没有指定具体的主机名(ip)和用户，而只是&quot;bebop&quot;，这是如何做到的呢？且看下文</p>
<h3>使用别名</h3>
<p>假如在一个主机上为不同用户分别开通了不同的ssh账号，连接时就得这样</p>
<div class="highlight"><pre><code class="bash">wdaher@rocksteady:~<span class="nv">$ </span>ssh -p 2222 bob.example.com
wdaher@rocksteady:~<span class="nv">$ </span>ssh -p 8183 waseem@alice.example.com
wdaher@rocksteady:~<span class="nv">$ </span>ssh -p 31337 -l waseemio wsd.example.com
</code></pre>
</div>
<p>很麻烦，而且端口或者其他参数有变动的话，不一定记得住。其实只要配置一下.ssh/config文件就可以了。</p>
<pre>
Host bob
    HostName bob.example.com
    Port 2222
    User wdaher

Host alice
    HostName alice.example.com
    Port 8183
    User waseem

Host self
    HostName wsd.example.com
    Port 31337
    User waseemio
</pre>
<p>连接时，就变成这样了</p>
<div class="highlight"><pre><code class="bash">wdaher@rocksteady:~<span class="nv">$ </span>ssh bob
wdaher@rocksteady:~<span class="nv">$ </span>ssh alice
wdaher@rocksteady:~<span class="nv">$ </span>ssh self
</code></pre>
</div>
<p>是不是很方便，如果SSH的参数改变的话，修改配置文件就行了，命令不变。</p>
<h3>端口转发</h3>
<p>假设有这么个情况：你已下班回家，这时想要查看公司内网(analytics)的某个web页，但只能SSH到自己在公司的电脑(desktop)，desktop和analytics在一个局域网。</p>
<p>先来看一段命令</p>
<div class="highlight"><pre><code class="bash">ssh desktop -L 8080:desktop:80
</code></pre>
</div>
<p>这段命令表示的是ssh连到desktop后，转发本地8080端口到desktop的80端口，这时，如果访问&quot;http://localhost:8080&quot;，就会转发到desktop的80端口。这样的话，把desktop:80换成analytics:80不就大功告成了吗</p>
<div class="highlight"><pre><code class="bash">ssh desktop -L 8080:analytics:80
</code></pre>
</div>
<p>这样访问本地的8080端口，就会转到analytics的80端口，通过desktop这个跳板。</p>
<p>更加一劳永逸的方法是使用-D参数，将desktop变成一个<a href="http://baike.baidu.com/view/490489.htm?fr=ala0_1">socks5</a>代理服务器(对这个-D命令，大家应该都很熟悉了吧)，然后在浏览器中配置代理为&quot;localhost:8080&quot;</p>
<div class="highlight"><pre><code class="bash">ssh desktop -D 8080 desktop
</code></pre>
</div>
<p>这样所有的浏览器访问都会通过desktop进行转发，也就是说直接访问http://analytics就可以了。(analytics地址在hosts里配置，如192.168.1.110 analytics)</p>
<h3>使用&quot;~&quot;</h3>
<p>&#8220;~&#8221;(不包括引号)是ssh保留字符，在新行输入&quot;~&#8220;后，可以配合很多键，其中最常用的就是&#8221;~.&#8220;和&#8221;~^Z&quot;(Ctrl+Z)</p>
<p>&#8220;~.&#8221;会终止ssh连接，如果中断了连接，又不想等ssh session过期，就可以使用这个快捷键。</p>
<p>&#8220;~^Z&#8221;会把当前的ssh连接放到后台，等完成了其他工作后，再把这个连接取出来。</p>
<div class="highlight"><pre><code class="bash">wdaher@rocksteady:~<span class="nv">$ </span>ssh bebop
wdaher@bebop:~<span class="nv">$ </span>sleep 10000
wdaher@bebop:~<span class="nv">$ </span>~^Z <span class="o">[</span><span class="nb">suspend </span>ssh<span class="o">]</span>

<span class="o">[</span>1<span class="o">]</span>+  Stopped                 ssh bebop
wdaher@rocksteady:~<span class="nv">$ </span><span class="c"># Do something else</span>
wdaher@rocksteady:~<span class="nv">$ </span><span class="nb">fg</span> <span class="c"># and you&#39;re back!</span>
</code></pre>
</div>
<h3>通过authorized_keys指定登录后要执行的命令</h3>
<p>这个跟前面提到的&quot;连接成功后运行命令&quot;不一样，这个命令是定义在authorized_keys里的，ssh连上后，只能执行该命令，并且执行完后立即退出。</p>
<p>先看看正常的authorized_keys<br />
<pre><br />
ssh-dss AAAAB3NzaC1kc3MAAAEBAKYJenaYvMG3nHwWxKwlWLjHb77CT2hXwmC8Ap+fG8wjlaY/9t4u<br />
A+2qx9JNorgdrWKhHSKHokFFlWRj+qk3q+lGHS+hsXuvta44W0yD0y0sW62wrEVegz+JVmntxeYc0nDz<br />
5tVGfZe6ydlgomzj1bhfdpYe+BAwop8L+EMqKLS4iSacNjoPlHsmqHMnbibn3tBqJEq2QJjEPaiYj1iP<br />
5IaCuYBhuTKQGa+oyH3mXEif5CKdsIKBj46B0tCy0/GC7oWcUN92QdLrUyTeRJZsTWsxKpRbMliD2pBh<br />
4oyX/aXEf8+HZBrO5vQjDBCfTFQA+35Xrd3eTVEjkGkncI0SAeUAAAAVAMZSASmQ9Pi38mdm6oiVXD55<br />
Kk2rAAABAE/bA402VuCsOLg9YS0NKxugT+o4UuIjyl6b2/cMmBVWO39lWAjcsKK/zEdJbrOdt/sKsxIK<br />
1/ZIvtl92DLlMhci5c4tBjCODey4yjLhApjWgvX9D5OPp89qhah4zu509uNX7uH58Zw/<ins>m6ZOLHN28mV<br />
5KLUl7FTL2KZ583KrcWkUA0Id4ptUa9CAkcqn/gWkHMptgVwaZKlqZ</ins>QtEa0V2IwUDWS097p3SlLvozw<br />
46+ucWxwTJttCHLzUmNN7w1cIv0w/OHh5IGh+wWjV9pbO0VT3/r2jxkzqksKOYAb5CYzSNRyEwp+NIKr<br />
Y+aJz7myu4Unn9de4cYsuXoAB6FQ5I8AAAEBAJSmDndXJCm7G66qdu3ElsLT0Jlz/es9F27r+xrg5pZ5<br />
GjfBCRvHNo2DF4YW9MKdUQiv+ILMY8OISduTeu32nyA7dwx7z5M8b+DtasRAa1U03EfpvRQps6ovu79m<br />
bt1OE8LS9ql8trx8qyIpYmJxmzIdBQ+kzkY+9ZlaXsaU0Ssuda7xPrX4405CbnKcpvM6q6okMP86Ejjn<br />
75Cfzhv65hJkCjbiF7FZxosCRIuYbhEEKu2Z9Dgh+ZbsZ+9FETZVzKBs4fySA6dIw6zmGINd+KY6umMW<br />
yJNej2Sia70fu3XLHj2yBgN5cy8arlZ80q1Mcy763RjYGkR/FkLJ611HWIA= thisuser@thishost<br />
</pre></p>
<p>修改之后，就是这样<br />
<pre><br />
from=&#8220;10.1.1.1&#8221;,command=&#8220;/home/remoteuser/command&#8221; ssh-dss <span class="caps">AAAA</span>&#8230;<br />
</pre></p>
<p>其实就是在最前面加了from和command，from表明从哪个ip连过来的，如果是用adsl拨号上网，ip会经常变动，可以把这个参数去掉。command表明连接成功后要执行的命令，可以在command里限制该用户可以执行的命令(别忘了加上可执行权限)，假设限制该用户只能执行rsync命令:</p>
<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/sh</span>

<span class="k">case</span> <span class="s2">&quot;$SSH_ORIGINAL_COMMAND&quot;</span> in
*<span class="se">\&amp;</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
*<span class="se">\(</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
*<span class="se">\{</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
*<span class="se">\;</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
*<span class="se">\&lt;</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
*<span class="se">\`</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
*<span class="se">\|</span>*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
rsync<span class="se">\ </span>--server*<span class="o">)</span>
<span class="nv">$SSH_ORIGINAL_COMMAND</span>
;;
*<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;Rejected&quot;</span>
;;
<span class="k">esac</span> 
</code></pre>
</div>
<p>$SSH_ORIGINAL_COMMAND表示的是用户实际执行的命令</p>
<h3>其他技巧</h3>
<h4>禁止Root用户登录</h4>
<p>允许root用户登录太危险了(虽然很方便)，因为可以删除任何文件，可以在&#8217;/etc/ssh/sshd_config&#8217;里配置一下。</p>
<div class="highlight"><pre><code class="bash">PermitRootLogin no 
<span class="c">#或者只允许执行有限的命令</span>
PermitRootLogin forced-commands-only 
</code></pre>
</div>
<h4>免密码登录</h4>
<p>先用ssh-keygen生成一对私钥和公钥，然后把公钥添加到远程主机的authorized_keys里就行了</p>
<div class="highlight"><pre><code class="bash"><span class="c">#生成私钥和公钥，默认放在~/.ssh/文件夹下，也可以自定义，提示输入passphare时，直接回车</span>
<span class="c">#顺利的话就会在~/.ssh/文件夹下生成id_rsa.pub和id_rsa两个文件</span>
ssh-keygen -t rsa

<span class="c">#把id_rsa.pub上传到远程主机，方法很多，ssh-copy-id只是其中一种</span>
ssh-copy-id username@hostname
<span class="c">#如果id_rsa.pub在其他文件夹下</span>
ssh-copy-id -i /path/to/id_rsa.pub username@hostname
</code></pre>
</div>
<p>这样下次就可以直接登录了</p>
					<br />
					--EOF--
					<p>若无特别说明，本站文章均为原创，转载请保留链接，谢谢</p>
				</div>
				<div id="disqus_thread"></div>
				<script type="text/javascript">
				  /**
				    * var disqus_identifier; [Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread] 
				    */
				  (function() {
				   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				   dsq.src = 'http://lzyyblog.disqus.com/embed.js';
				   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
				  })();
				</script>
				<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=lzyyblog">comments powered by Disqus.</a></noscript>
			</div>

				<div id="footer">
					<div id="feed">
						<div class="badget" id="github">
							<a href="http://github.com/lzyy">
							<span class="service">github</span>
							<span class="info"> </span>
							</a>
						</div>
						<div class="badget" id="twt">
							<a href="http://twitter.com/lzyy">
							<span class="service">twitter</span>
							<span class="info"> </span>
							</a>
						</div>
						<div class="badget" id="feedburner">
							<a href="http://feeds.feedburner.com/lzyy">
							<span class="service">rss</span>
							<span class="info"> </span>
							</a>
						</div>
					</div>
					<span style="color:#bbb;font-size:12px">make the world a little better and eaiser</span>
					<p style="clear:both"></p>
				</div>

				<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>

<script type="text/javascript">
	jQuery.cookie = function (key, value, options) {
    
    // key and at least value given, set cookie...
    if (arguments.length > 1 && String(value) !== "[object Object]") {
        options = jQuery.extend({}, options);

        if (value === null || value === undefined) {
            options.expires = -1;
        }

        if (typeof options.expires === 'number') {
            var days = options.expires, t = options.expires = new Date();
            t.setDate(t.getDate() + days);
        }
        
        value = String(value);
        
        return (document.cookie = [
            encodeURIComponent(key), '=',
            options.raw ? value : encodeURIComponent(value),
            options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
            options.path ? '; path=' + options.path : '',
            options.domain ? '; domain=' + options.domain : '',
            options.secure ? '; secure' : ''
        ].join(''));
    }

    // key and possibly options given, get cookie...
    options = value || {};
    var result, decode = options.raw ? function (s) { return s; } : decodeURIComponent;
    return (result = new RegExp('(?:^|; )' + encodeURIComponent(key) + '=([^;]*)').exec(document.cookie)) ? decode(result[1]) : null;
};

if(!$.cookie('badget-twt'))
{
	url = 'http://199.19.225.142/proxy/twt.php';
	$.getJSON(url+"?callback=?", function(data){
		f_count = data['followers_count'];
		$('#twt').find('.info').text(f_count);
		$.cookie('badget-twt', f_count, {expires: 7} );
	});
}
else
{
	$('#twt').find('.info').text($.cookie('badget-twt'));
}



if(!$.cookie('badget-github'))
{
	url = 'http://leezhong.com/util/proxy/github.php';
	$.getJSON(url+"?callback=?", function(data){
		var text = data['user']['public_repo_count'] + ' / ' + data['user']['followers_count'];
		$('#github').find('.info').text(text);
		$.cookie('badget-github', text, {expires: 7} );
	});
}
else
{
	$('#github').find('.info').text($.cookie('badget-github'));
}

if(!$.cookie('badget-feedburner'))
{
	url = 'http://leezhong.com/util/proxy/feedburner.php';
	$.getJSON(url+"?callback=?", function(data){
		$('#feedburner').find('.info').text(data['count']);
		$.cookie('badget-feedburner', data['count'], {expires: 7} );
	});
}
else
{
	$('#feedburner').find('.info').text($.cookie('badget-feedburner'));
}
</script>

	</body>
</html>

