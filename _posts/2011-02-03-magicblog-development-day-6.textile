---
layout: post
title: magicblog开发日记(6)-从wordpress导入数据
category: essay
---

能够从其他平台导入数据是博客的重要功能之一，而wordpress是使用最广泛的blog engine，我决定实现从wordpress导入数据的功能。
关于如何实现这一功能，我考虑了一段时间，最后还是决定用wordpress导出的xml文件来作为数据源。其实还有几种其他可能的方法，我感觉都有弊端，有人和我遇到过类似的问题，<a href="http://www.eriksmartt.com/blog/archives/306">他的分析</a>不错，推荐一下。
wordpress导出的是xml文件，首先需要解析(parse)，之后把解析出来的数据写入magicblog的数据库即可，从逻辑上来讲非常简单，细心一点就OK。
我使用xml.etree.ElementTree来处理XML，并且构造了一个用来解析wordpress日期的方法，叫做parse_date，如下

[code]
def parse_date(date_str):
	try:
		date = datetime.strptime(date_str ,&quot;%Y-%m-%d %H:%M:%S&quot;)
	except:
		try:
			date = datetime.strptime(date_str ,&quot;%a, %d %b %Y %H:%M:%S&quot;)
		except:
			date = datetime.now()
	return date
[/code]

超简单，不解释。
然后就是具体的解析xml，写入数据库的过程了，先贴代码，再解释：

[code]
def import_wp(request):
	wpns = &quot;{http://wordpress.org/export/1.0/}&quot;
	contentns = &quot;{http://purl.org/rss/1.0/modules/content/}&quot;
	excerptns = &quot;{http://wordpress.org/export/1.0/excerpt/}&quot;

	root = ET.parse(os.path.join(os.path.abspath(os.path.dirname(__file__)),'wordpress.xml')).getroot().find('channel')

	for item in root.findall(wpns+'category'):
		category = Category()
		category.name = item.findtext(wpns+'cat_name')
		category.save()

	for item in root.findall(wpns+'tag'):
		tag = Tag()
		tag.name = item.findtext(wpns+'tag_name')
		tag.save()

	for item in root.findall('item'):
		post = Post()
		post.author_id = 1
		post.title = item.findtext('title')
		post.slug = item.findtext(wpns+'post_id')
		post.body = item.findtext(contentns+'encoded')
		post.excerpt = item.findtext(excerptns+'encoded')
		post.published = True

		date = item.findtext(wpns+'post_date')

		post.pub_date = parse_date(date)

		post.up_date = post.pub_date

		post.save()

		categories = item.findall(&quot;category&quot;)
		for c in categories:
			if c.attrib.has_key('nicename'):
				nicename = c.attrib['nicename']
				cat_type = c.attrib['domain']
				if cat_type == 'tag':
					tag = Tag.objects.get(name=c.text)
					if tag:
						post.tags.add(tag)
				else:
					cat = Category.objects.get(name=c.text)
					if cat:
						post.categories.add(cat)

		post.save()

		comments = item.findall(wpns+'comment')
		for c in comments:
			comment = Comment()
			comment.content_object = post

			comment.site_id = 1

			comment.user_name = c.findtext(wpns+'comment_author')
			comment.user_email = c.findtext(wpns+'comment_author_email')
			comment.user_url = c.findtext(wpns+'comment_author_url')

			date = c.findtext(wpns+'comment_date')
			comment.submit_date = parse_date(date)

			comment.comment = c.findtext(wpns+'comment_content')
			comment.is_public = True

			comment.save()
	return redirect('/')
[/code]

根据wordpress的导出xml根式，我们最好先定义三个name space : wpns, contentns, excerptns，以备后用。
然后就是先导入category,在导入tag，然后就是post，最后是comment
that's all
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
至此，magicblog已经全部完成了！实现了想要实现的所有功能。
如果开始的时候没设定一个开发计划的话，估计我很难坚持下来，即使坚持下来也要多好很多时间。
接下来要做的就是一些优化工作，最终部署到我自己的aws服务器上。
以后我就不用wordpress了，我用自己写的magicblog，用自己做的东西感觉还是很自豪的。